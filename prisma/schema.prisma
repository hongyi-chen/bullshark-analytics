generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Athlete {
  id          String        @id
  firstname   String?
  lastname    String?
  connectedAt DateTime      @default(now())
  revokedAt   DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  token      AthleteToken?

  @@index([revokedAt])
}

model AthleteToken {
  athleteId       String   @id
  refreshTokenEnc String
  accessTokenEnc  String?
  expiresAt       Int?
  scope           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  athlete Athlete @relation(fields: [athleteId], references: [id], onDelete: Cascade)
}

// Club feed storage (no per-athlete OAuth required beyond the service account)
// Note: club activities payloads may not include stable activity ids or timestamps.
model ClubFeedActivity {
  id         String   @id @default(cuid())
  clubId     String
  fetchedAt  DateTime @default(now())

  athleteName String?
  name        String?
  type        String?
  sportType   String?
  distanceM   Float?
  movingTimeS Int?
  elapsedTimeS Int?
  totalElevationGainM Float?

  // Best-effort dedupe key computed from payload fields
  dedupeHash String

  raw Json

  @@index([clubId, fetchedAt])
  @@index([athleteName])
  @@unique([clubId, dedupeHash])
}
